<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multiplayer Snake</title>
<style>
  :root{ --page:#1a1d1f; --arena:#2a2f34; --panel:#111418; --text:#f5f7fa; --badge:#ffffff14; }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--page); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

  /* Login */
  #loginScreen{ min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:16px; }
  #loginCard{ width:min(440px,92vw); background:#0f1316; border:1px solid #ffffff22; border-radius:14px; box-shadow:0 10px 28px #0008; padding:22px; text-align:center; }
  #loginCard h2{ margin:0 0 12px }
  .fld{ width:100%; padding:12px 14px; border-radius:10px; border:1px solid #ffffff22; background:#11161a; color:#fff; font-size:16px; }
  .fld::placeholder{ color:#9aa4ad }
  .btn{ width:100%; padding:12px 14px; border-radius:10px; border:0; background:#e9ebef; color:#111; font-weight:700; cursor:pointer; }
  .error{ color:#ff6b6b; font-size:14px; min-height:18px; margin-top:6px; }

  /* Game */
  #gameScreen{ display:none; padding:12px 16px 24px }
  #hud{ width:min(860px,95vw); margin:0 auto 10px; background:#111418; border-radius:12px; padding:10px 14px; box-shadow:0 6px 24px #0006; display:flex; justify-content:center; gap:10px; font-weight:700; }
  .badge{ padding:6px 10px; border-radius:10px; background:#ffffff14; }
  #stageWrap{ position:relative; width:100%; display:flex; justify-content:center; }
  #gameCanvas{ background:var(--arena); border-radius:14px; box-shadow:0 12px 36px #000a, inset 0 0 0 1px #0008; touch-action:none; display:block; margin:0 auto; }
  #overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; pointer-events:auto; }
  #overlay .box{ background:#12161aee; border:1px solid #ffffff22; padding:20px; border-radius:14px; text-align:center; }
  .btn-row{ display:flex; gap:8px; margin-top:10px; justify-content:center; }

  /* Countdown */
  #countdown { position:absolute; inset:0; display:none; align-items:center; justify-content:center; font-size:72px; font-weight:800; color:white; text-shadow:0 0 8px black; pointer-events:none; }

  /* Top100 Modal */
  #hsModal{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:10; }
  #hsPanel{ position:relative; width:min(720px,92vw); max-height:80vh; overflow:auto; background:#0e1114; border:1px solid #ffffff22; border-radius:14px; box-shadow:0 10px 30px #000a; padding:14px 16px; }
  #hsClose{ position:absolute; top:8px; right:10px; border:0; background:transparent; color:#fff; font-size:22px; cursor:pointer; }
  #hsList{ list-style:none; padding-left:0; margin:0; }
  #hsList li{ display:flex; align-items:center; gap:8px; padding:3px 0; }
  #hsList .rank{ width:26px; text-align:right; opacity:.85; }
  #hsList .name{ flex:1; text-align:left; font-weight:600; }
  #hsList .score{ width:48px; text-align:left; opacity:.9; }

  /* === Draggable Joystick (mobile only) === */
  #joyWrap{
    display:none; position:fixed; left:16px; bottom:16px; z-index:20;
    width:160px; user-select:none;
  }
  #joyHandle{
    height:22px; line-height:22px; text-align:center; font-size:14px;
    color:#cbd5e1; border:1px solid #ffffff22; border-bottom:0; border-radius:12px 12px 0 0;
    background:#0e1114cc; backdrop-filter: blur(6px); cursor:grab;
  }
  #joyBase{
    width:160px; height:160px; border-radius:16px; border:1px solid #ffffff22;
    background:#0e1114aa; backdrop-filter: blur(6px); position:relative; touch-action:none;
  }
  #joyRing{
    position:absolute; left:50%; top:50%;
    width:120px; height:120px; margin:-60px 0 0 -60px;
    border-radius:50%; border:1px dashed #ffffff33;
  }
  #joyKnob{
    position:absolute; left:50%; top:50%;
    width:64px; height:64px; margin:-32px 0 0 -32px;
    border-radius:50%;
    background:#ffffff33; border:2px solid #ffffff55;
  }
  @media (pointer:coarse){
    #joyWrap{ display:block; }
  }
  @media (pointer:fine){
    #joyWrap{ display:none !important; } /* masaüstünde gizle */
  }
</style>
</head>
<body>

<!-- LOGIN -->
<section id="loginScreen">
  <div id="loginCard">
    <h2>Multiplayer Snake</h2>
    <input id="nickname" class="fld" type="text" placeholder="Kullanıcı adı (max 15)" maxlength="15">
    <div id="loginError" class="error"></div>
    <button id="startBtn" class="btn">Oyuna Başla</button>
  </div>
</section>

<!-- GAME -->
<section id="gameScreen">
  <div id="hud">
    <div class="badge">Beyaz ⚪ <span id="s1">0</span></div>
    <div class="badge">Süre ⏱ <span id="tm">300</span>s</div>
    <div class="badge">Gri ◍ <span id="s2">0</span></div>
  </div>

  <div id="stageWrap">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="countdown"></div>
    <div id="overlay">
      <div class="box">
        <h2 id="resultText">Sonuç</h2>
        <div id="resultScore" style="opacity:.85; margin-bottom:8px;"></div>
        <div class="btn-row">
          <button id="restartBtn" class="btn">Yeniden Oyna</button>
          <button id="newOpponentBtn" class="btn">Yeni Rakip Bul</button>
          <button id="showHSBtn" class="btn">Top 100'ü Gör</button>
        </div>
        <div id="waitInfo" style="opacity:.8; margin-top:6px; display:none;">Rakip bekleniyor...</div>
      </div>
    </div>
  </div>

  <!-- Mobile Joystick -->
  <div id="joyWrap">
    <div id="joyHandle">≡ Joystick</div>
    <div id="joyBase">
      <div id="joyRing"></div>
      <div id="joyKnob"></div>
    </div>
  </div>
</section>

<!-- Top100 Modal -->
<div id="hsModal">
  <div id="hsPanel">
    <button id="hsClose" title="Kapat">×</button>
    <h3 style="margin:0 0 8px;">Top 100</h3>
    <ol id="hsList"></ol>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(()=> {
  // Elements
  const loginScreen=document.getElementById('loginScreen'),
        nicknameInput=document.getElementById('nickname'),
        loginError=document.getElementById('loginError'),
        startBtn=document.getElementById('startBtn'),
        gameScreen=document.getElementById('gameScreen'),
        s1=document.getElementById('s1'), s2=document.getElementById('s2'), tm=document.getElementById('tm'),
        canvas=document.getElementById('gameCanvas'), ctx=canvas.getContext('2d'),
        overlay=document.getElementById('overlay'), resultText=document.getElementById('resultText'),
        resultScore=document.getElementById('resultScore'), restartBtn=document.getElementById('restartBtn'),
        newOpponentBtn=document.getElementById('newOpponentBtn'), waitInfo=document.getElementById('waitInfo'),
        showHSBtn=document.getElementById('showHSBtn'), countdown=document.getElementById('countdown'),
        hsModal=document.getElementById('hsModal'), hsClose=document.getElementById('hsClose'), hsList=document.getElementById('hsList');

  // Joystick elements
  const joyWrap=document.getElementById('joyWrap'),
        joyHandle=document.getElementById('joyHandle'),
        joyBase=document.getElementById('joyBase'),
        joyKnob=document.getElementById('joyKnob');

  // Canvas auto-fit
  const BASE_W=800, BASE_H=600;
  function fitCanvas(){
    const availW=Math.min(window.innerWidth*0.98,1200);
    const availH=window.innerHeight*0.70; // joystick için alttan boşluk
    const scale=Math.min(availW/BASE_W, availH/BASE_H);
    canvas.style.width=(BASE_W*scale)+'px';
    canvas.style.height=(BASE_H*scale)+'px';
  }
  window.addEventListener('resize', fitCanvas); fitCanvas();

  const socket=io();

  // Login
  startBtn.addEventListener('click', ()=>{
    const nick=nicknameInput.value.trim();
    if(!nick){ loginError.textContent='Kullanıcı adı boş olamaz!'; return; }
    if(nick.length>15){ loginError.textContent='Kullanıcı adı en fazla 15 karakter olabilir.'; return; }
    loginError.textContent='';
    socket.emit('set_nick', nick);
  });
  socket.on('nick_error', msg=>loginError.textContent=msg);

  // Match start -> show game, run countdown, then tell server
  socket.on('match_start', data=>{
    loginScreen.style.display='none';
    gameScreen.style.display='block';
    overlay.style.display='none';
    waitInfo.style.display='none';
    s1.textContent='0'; s2.textContent='0'; tm.textContent=data.duration;
    fitCanvas();

    // sadece mobilde joystick göster
    if (window.matchMedia('(pointer: coarse)').matches) {
      joyWrap.style.display='block';
    } else {
      joyWrap.style.display='none';
    }

    startCountdown(()=>{ socket.emit('countdown_done'); });
  });

  socket.on('rematch_wait', rdy=>{
    waitInfo.style.display = (rdy.p1 && rdy.p2) ? 'none' : 'block';
  });

  // Game state
  socket.on('state', st=>{
    if(!st.over){ tm.textContent=st.left; }
    s1.textContent=st.p1.score;
    s2.textContent=st.p2.score;

    const grid=20, W=BASE_W, H=BASE_H;
    ctx.clearRect(0,0,W,H);
    ctx.save(); ctx.strokeStyle='#ffffff'; ctx.lineWidth=4; ctx.strokeRect(2,2,W-4,H-4); ctx.restore();

    if(st.food){ ctx.fillStyle='red'; ctx.fillRect(st.food.x*grid, st.food.y*grid, grid, grid); }
    if(st.sfood){ ctx.fillStyle='gold'; ctx.fillRect(st.sfood.x*grid, st.sfood.y*grid, grid, grid); }

    // P1: Beyaz
    ctx.fillStyle='#fff';
    for(const p of st.p1.body){
      ctx.fillRect(p.x*grid,p.y*grid,grid,grid);
      ctx.strokeStyle='#111'; ctx.lineWidth=1; ctx.strokeRect(p.x*grid+0.5,p.y*grid+0.5,grid-1,grid-1);
    }
    // P2: Gri
    ctx.fillStyle='#9aa0a6';
    for(const p of st.p2.body){ ctx.fillRect(p.x*grid,p.y*grid,grid,grid); }

    if(st.over){
      overlay.style.display='flex';
      resultText.textContent = st.winner==='p1' ? (st.n1+' Kazandı!') : st.winner==='p2' ? (st.n2+' Kazandı!') : 'Berabere!';
      resultScore.textContent = `${st.n1}: ${st.p1.score} • ${st.n2}: ${st.p2.score}`;
      joyCenter();
      joyWrap.style.display='none';
    }
  });

  // Keyboard (PC)
  document.addEventListener('keydown', e=>{
    let dir=null;
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key))
      dir=keyToDir(e.key), socket.emit('input',{for:'p1', dir}); // Beyaz
    else if(['w','a','s','d'].includes(e.key))
      dir=keyToDir(e.key), socket.emit('input',{for:'p2', dir}); // Gri
  });
  function keyToDir(key){
    if(key==='ArrowUp'||key==='w') return {x:0,y:-1};
    if(key==='ArrowDown'||key==='s') return {x:0,y: 1};
    if(key==='ArrowLeft'||key==='a') return {x:-1,y:0};
    if(key==='ArrowRight'||key==='d') return {x:1,y:0};
    return {x:0,y:0};
  }

  // ===== Joystick logic (P1 only) =====
  const ringR = 60;           // ring yarıçap (joyRing 120px)
  const knobR = 32;           // knob yarıçap
  const dead = 10;            // ölü bölge
  let isDragStick=false, isDragPanel=false, lastDir='stop';

  // panel taşıma
  let startX=0,startY=0,origX=0,origY=0;
  joyHandle.addEventListener('pointerdown', (ev)=>{
    isDragPanel=true;
    const r = joyWrap.getBoundingClientRect();
    startX=ev.clientX; startY=ev.clientY; origX=r.left; origY=r.top;
    ev.preventDefault();
  });
  window.addEventListener('pointermove', (ev)=>{
    if(!isDragPanel) return;
    const dx=ev.clientX-startX, dy=ev.clientY-startY;
    joyWrap.style.left=(origX+dx)+'px';
    joyWrap.style.top=(origY+dy)+'px';
    joyWrap.style.right='auto'; joyWrap.style.bottom='auto';
  });
  window.addEventListener('pointerup', ()=>{ isDragPanel=false; });

  // stick sürükleme
  joyBase.addEventListener('pointerdown', (ev)=>{ isDragStick=true; handleJoy(ev); });
  window.addEventListener('pointermove', (ev)=>{ if(isDragStick) handleJoy(ev); });
  window.addEventListener('pointerup', ()=>{ if(isDragStick){ isDragStick=false; joyCenter(); sendDir('stop'); } });

  function handleJoy(ev){
    const br = joyBase.getBoundingClientRect();
    const cx = br.left + br.width/2;
    const cy = br.top  + br.height/2;
    const dx = ev.clientX - cx;
    const dy = ev.clientY - cy;
    const dist = Math.hypot(dx,dy);
    const clamped = Math.min(dist, ringR - knobR/2);
    const ang = Math.atan2(dy, dx); // -PI..PI

    // knob konumu
    const kx = Math.cos(ang) * clamped;
    const ky = Math.sin(ang) * clamped;
    joyKnob.style.transform = `translate(${kx}px, ${ky}px)`;

    // yön belirleme (4-yön quantize)
    let dir = 'stop';
    if (dist > dead){
      const ax = Math.abs(dx), ay = Math.abs(dy);
      if (ax > ay) dir = dx>0 ? 'right' : 'left';
      else         dir = dy>0 ? 'down'  : 'up';
    }
    sendDir(dir);
  }

  function joyCenter(){
    joyKnob.style.transform = 'translate(0px, 0px)';
  }

  function sendDir(dir){
    if (dir === lastDir) return;
    lastDir = dir;
    if (dir==='up')    socket.emit('input',{for:'p1', dir:{x:0,y:-1}});
    if (dir==='down')  socket.emit('input',{for:'p1', dir:{x:0,y: 1}});
    if (dir==='left')  socket.emit('input',{for:'p1', dir:{x:-1,y:0}});
    if (dir==='right') socket.emit('input',{for:'p1', dir:{x:1,y:0}});
    // 'stop' durumunda yön göndermiyoruz (yılan momentumla devam eder)
  }

  // Rematch / New opponent / Top100
  restartBtn.addEventListener('click', ()=>{ waitInfo.style.display='block'; socket.emit('rematch'); });
  newOpponentBtn.addEventListener('click', ()=>{ overlay.style.display='flex'; waitInfo.textContent='Yeni rakip aranıyor...'; waitInfo.style.display='block'; socket.emit('find_new'); });

  showHSBtn.addEventListener('click', async()=>{
    try{
      const res=await fetch('/highscores');
      const data=await res.json();
      hsList.innerHTML=data.map((r,i)=>(
        `<li><span class="rank">${i+1}.</span><span class="name">${escapeHtml(r.nick)}</span><span class="score">${r.score}</span></li>`
      )).join('');
      hsModal.style.display='flex';
    }catch(e){}
  });
  hsClose.addEventListener('click', ()=>hsModal.style.display='none');
  hsModal.addEventListener('click', e=>{ if(e.target===hsModal) hsModal.style.display='none'; });

  function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  // Countdown logic
  function startCountdown(cb){
    let count=3;
    countdown.style.display='flex';
    countdown.textContent=count;
    const int=setInterval(()=>{
      count--;
      if(count>0) countdown.textContent=count;
      else if(count===0) countdown.textContent='Başla!';
      else{
        clearInterval(int);
        countdown.style.display='none';
        cb();
      }
    },1000);
  }
})();
</script>
</body>
</html>
