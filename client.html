<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multiplayer Snake</title>
<style>
  :root{ --page:#1a1d1f; --arena:#2a2f34; --panel:#111418; --text:#f5f7fa; --badge:#ffffff14; }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--page); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

  /* Login */
  #loginScreen{ min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:16px; }
  #loginCard{ width:min(440px,92vw); background:#0f1316; border:1px solid #ffffff22; border-radius:14px; box-shadow:0 10px 28px #0008; padding:22px; text-align:center; }
  #loginCard h2{ margin:0 0 12px }
  .fld{ width:100%; padding:12px 14px; border-radius:10px; border:1px solid #ffffff22; background:#11161a; color:#fff; font-size:16px; }
  .fld::placeholder{ color:#9aa4ad }
  .btn{ width:100%; padding:12px 14px; border-radius:10px; border:0; background:#e9ebef; color:#111; font-weight:700; cursor:pointer; }
  .error{ color:#ff6b6b; font-size:14px; min-height:18px; margin-top:6px; }

  /* Game */
  #gameScreen{ display:none; padding:12px 16px 24px }
  #hud{ width:min(860px,95vw); margin:0 auto 10px; background:#111418; border-radius:12px; padding:10px 14px; box-shadow:0 6px 24px #0006; display:flex; justify-content:center; gap:10px; font-weight:700; }
  .badge{ padding:6px 10px; border-radius:10px; background:#ffffff14; }
  #stageWrap{ position:relative; width:100%; display:flex; justify-content:center; }
  #gameCanvas{ background:var(--arena); border-radius:14px; box-shadow:0 12px 36px #000a, inset 0 0 0 1px #0008; touch-action:none; display:block; margin:0 auto; }
  #countdown { position:absolute; inset:0; display:none; align-items:center; justify-content:center; font-size:72px; font-weight:800; color:white; text-shadow:0 0 8px black; pointer-events:none; }

  /* Oyun sonu overlay */
  #overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; pointer-events:auto; }
  #overlay .box{ background:#12161aee; border:1px solid #ffffff22; padding:20px; border-radius:14px; text-align:center; }
  .btn-row{ display:flex; gap:8px; margin-top:10px; justify-content:center; }

  /* Top100 Modal */
  #hsModal{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:10; }
  #hsPanel{ position:relative; width:min(720px,92vw); max-height:80vh; overflow:auto; background:#0e1114; border:1px solid #ffffff22; border-radius:14px; box-shadow:0 10px 30px #000a; padding:14px 16px; }
  #hsClose{ position:absolute; top:8px; right:10px; border:0; background:transparent; color:#fff; font-size:22px; cursor:pointer; }
  #hsList{ list-style:none; padding-left:0; margin:0; }
  #hsList li{ display:flex; align-items:center; gap:8px; padding:3px 0; }
  #hsList .rank{ width:26px; text-align:right; opacity:.85; }
  #hsList .name{ flex:1; text-align:left; font-weight:600; }
  #hsList .score{ width:48px; text-align:left; opacity:.9; }

  /* Tek D-pad (mobil) — oyun alanının ALTINDA */
  #dpadWrap{
    display:none;           /* oyun başlayınca ve mobilde açılacak */
    margin:12px auto 0;
    width:100%; max-width:860px;
    display:flex;           /* JS ile block/flex değiştiriyoruz */
    justify-content:center;
    user-select:none; touch-action:none;
  }
  #dpad{
    position:relative; width:180px; height:180px; border-radius:20px;
    background:#0e1114b0; border:1px solid #ffffff22; backdrop-filter:blur(6px);
    box-shadow:0 8px 24px #0008;
  }
  .arrow{
    position:absolute; display:flex; align-items:center; justify-content:center;
    color:#e9eef5; font-weight:800; font-size:22px; opacity:.9;
    background:#ffffff14; border:1px solid #ffffff22; border-radius:12px;
  }
  .arrow.up{    left:66px; top:10px;   width:48px; height:56px; }
  .arrow.down{  left:66px; bottom:10px;width:48px; height:56px; }
  .arrow.left{  top:66px; left:10px;   width:56px; height:48px; }
  .arrow.right{ top:66px; right:10px;  width:56px; height:48px; }
  #ring{
    position:absolute; left:50%; top:50%; width:120px; height:120px; margin:-60px 0 0 -60px;
    border-radius:50%; border:1px dashed #ffffff30;
  }
  #knob{
    position:absolute; left:50%; top:50%; width:50px; height:50px; margin:-25px 0 0 -25px;
    border-radius:50%; background:#ffffff26; border:2px solid #ffffff55;
    transition:transform .08s ease;
  }
  @media (pointer:fine){ #dpadWrap{ display:none !important; } } /* masaüstünde gizle */
</style>
</head>
<body>

<!-- LOGIN -->
<section id="loginScreen">
  <div id="loginCard">
    <h2>Multiplayer Snake</h2>
    <input id="nickname" class="fld" type="text" placeholder="Kullanıcı adı (max 15)" maxlength="15">
    <div id="loginError" class="error"></div>
    <button id="startBtn" class="btn">Oyuna Başla</button>
  </div>
</section>

<!-- GAME -->
<section id="gameScreen">
  <div id="hud">
    <div class="badge">Beyaz ⚪ <span id="s1">0</span></div>
    <div class="badge">Süre ⏱ <span id="tm">300</span>s</div>
    <div class="badge">Gri ◍ <span id="s2">0</span></div>
  </div>

  <div id="stageWrap">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="countdown"></div>
    <div id="overlay">
      <div class="box">
        <h2 id="resultText">Sonuç</h2>
        <div id="resultScore" style="opacity:.85; margin-bottom:8px;"></div>
        <div class="btn-row">
          <button id="restartBtn" class="btn">Yeniden Oyna</button>
          <button id="newOpponentBtn" class="btn">Yeni Rakip Bul</button>
          <button id="showHSBtn" class="btn">Top 100'ü Gör</button>
        </div>
        <div id="waitInfo" style="opacity:.8; margin-top:6px; display:none;">Rakip bekleniyor...</div>
      </div>
    </div>
  </div>

  <!-- D-Pad: CANVAS ALTINDA -->
  <div id="dpadWrap" aria-label="Yön D-Pad">
    <div id="dpad">
      <div class="arrow up">▲</div>
      <div class="arrow down">▼</div>
      <div class="arrow left">◀</div>
      <div class="arrow right">▶</div>
      <div id="ring"></div>
      <div id="knob"></div>
    </div>
  </div>
</section>

<!-- Top100 Modal -->
<div id="hsModal">
  <div id="hsPanel">
    <button id="hsClose" title="Kapat">×</button>
    <h3 style="margin:0 0 8px;">Top 100</h3>
    <ol id="hsList"></ol>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(()=> {
  const loginScreen=document.getElementById('loginScreen'),
        nicknameInput=document.getElementById('nickname'),
        loginError=document.getElementById('loginError'),
        startBtn=document.getElementById('startBtn'),
        gameScreen=document.getElementById('gameScreen'),
        s1=document.getElementById('s1'), s2=document.getElementById('s2'), tm=document.getElementById('tm'),
        canvas=document.getElementById('gameCanvas'), ctx=canvas.getContext('2d'),
        overlay=document.getElementById('overlay'), resultText=document.getElementById('resultText'),
        resultScore=document.getElementById('resultScore'), restartBtn=document.getElementById('restartBtn'),
        newOpponentBtn=document.getElementById('newOpponentBtn'), waitInfo=document.getElementById('waitInfo'),
        showHSBtn=document.getElementById('showHSBtn'),
        countdown=document.getElementById('countdown'),
        hsModal=document.getElementById('hsModal'), hsClose=document.getElementById('hsClose'), hsList=document.getElementById('hsList'),
        dpadWrap=document.getElementById('dpadWrap'), dpad=document.getElementById('dpad'), ring=document.getElementById('ring'), knob=document.getElementById('knob');

  // Canvas auto-fit
  const BASE_W=800, BASE_H=600;
  function fitCanvas(){
    const availW=Math.min(window.innerWidth*0.98,1200);
    const availH=window.innerHeight*0.70; // altta d-pad için yer
    const scale=Math.min(availW/BASE_W, availH/BASE_H);
    canvas.style.width=(BASE_W*scale)+'px';
    canvas.style.height=(BASE_H*scale)+'px';
  }
  window.addEventListener('resize', fitCanvas); fitCanvas();

  // Socket (websocket)
  const socket = io({ transports: ['websocket'] });

  // Login
  startBtn.addEventListener('click', ()=>{
    const nick=nicknameInput.value.trim();
    if(!nick){ loginError.textContent='Kullanıcı adı boş olamaz!'; return; }
    if(nick.length>15){ loginError.textContent='Kullanıcı adı en fazla 15 karakter olabilir.'; return; }
    loginError.textContent='';
    socket.emit('set_nick', nick);
  });
  socket.on('nick_error', msg=>loginError.textContent=msg);

  // Match start -> show game + countdown -> notify server
  socket.on('match_start', data=>{
    loginScreen.style.display='none';
    gameScreen.style.display='block';
    overlay.style.display='none';
    waitInfo.style.display='none';
    s1.textContent='0'; s2.textContent='0'; tm.textContent=data.duration;
    fitCanvas();

    // sadece mobilde d-pad göster (masaüstünde gizle)
    if (window.matchMedia('(pointer: coarse)').matches) dpadWrap.style.display='flex';
    else dpadWrap.style.display='none';

    startCountdown(()=> socket.emit('countdown_done') );
  });

  socket.on('rematch_wait', rdy=>{
    waitInfo.style.display = (rdy.p1 && rdy.p2) ? 'none' : 'block';
  });

  // Game state
  socket.on('state', st=>{
    if(!st.over){ tm.textContent=st.left; }
    s1.textContent=st.p1.score; s2.textContent=st.p2.score;

    const grid=20, W=BASE_W, H=BASE_H;
    ctx.clearRect(0,0,W,H);
    ctx.save(); ctx.strokeStyle='#ffffff'; ctx.lineWidth=4; ctx.strokeRect(2,2,W-4,H-4); ctx.restore();

    if(st.food){ ctx.fillStyle='red'; ctx.fillRect(st.food.x*grid, st.food.y*grid, grid, grid); }
    if(st.sfood){ ctx.fillStyle='gold'; ctx.fillRect(st.sfood.x*grid, st.sfood.y*grid, grid, grid); }

    // P1 (Beyaz)
    ctx.fillStyle='#fff';
    for(const p of st.p1.body){
      ctx.fillRect(p.x*grid,p.y*grid,grid,grid);
      ctx.strokeStyle='#111'; ctx.lineWidth=1; ctx.strokeRect(p.x*grid+0.5,p.y*grid+0.5,grid-1,grid-1);
    }
    // P2 (Gri)
    ctx.fillStyle='#9aa0a6';
    for(const p of st.p2.body) ctx.fillRect(p.x*grid,p.y*grid,grid,grid);

    if(st.over){
      overlay.style.display='flex';
      resultText.textContent = st.winner==='p1' ? ('Beyaz Kazandı!') : st.winner==='p2' ? ('Gri Kazandı!') : 'Berabere!';
      resultScore.textContent = `Beyaz: ${st.p1.score} • Gri: ${st.p2.score}`;
      dpadWrap.style.display='none';
      knob.style.transform='translate(0px,0px)'; lastDir='stop';
    }
  });

  // PC klavye: ok + WASD → sunucu rolüne göre benim yılanım
  document.addEventListener('keydown', (e)=>{
    const dir = keyToDir(e.key);
    if (!dir) return;
    socket.emit('input', { dir });
  });
  function keyToDir(key){
    if (key==='ArrowUp'   || key==='w' || key==='W') return {x:0,y:-1};
    if (key==='ArrowDown' || key==='s' || key==='S') return {x:0,y: 1};
    if (key==='ArrowLeft' || key==='a' || key==='A') return {x:-1,y:0};
    if (key==='ArrowRight'|| key==='d' || key==='D') return {x:1,y:0};
    return null;
  }

  // D-pad tek yüzey
  const ringR=60, knobR=25, dead=8;
  let dragging=false, lastDir='stop';

  dpad.addEventListener('pointerdown', (ev)=>{
    dragging=true; dpad.setPointerCapture?.(ev.pointerId);
    handlePad(ev); ev.preventDefault();
  }, {passive:false});
  window.addEventListener('pointermove', (ev)=>{ if(dragging) handlePad(ev); }, {passive:false});
  window.addEventListener('pointerup', ()=>{
    if(!dragging) return;
    dragging=false; knob.style.transform='translate(0px,0px)';
    lastDir='stop'; // stop göndermiyoruz; mevcut yön devam
  }, {passive:false});

  function handlePad(ev){
    const br=dpad.getBoundingClientRect();
    const cx=br.left+br.width/2, cy=br.top+br.height/2;
    const dx=ev.clientX-cx, dy=ev.clientY-cy;
    const ax=Math.abs(dx), ay=Math.abs(dy);
    const dist=Math.hypot(dx,dy);

    // knob görseli
    const max = ringR - knobR*0.6;
    const ang = Math.atan2(dy,dx);
    const clamp = Math.min(dist,max);
    knob.style.transform=`translate(${Math.cos(ang)*clamp}px,${Math.sin(ang)*clamp}px)`;

    // yön seç
    let dir='stop';
    if (dist>dead){
      if (ax>ay) dir = dx>0 ? 'right' : 'left';
      else       dir = dy>0 ? 'down'  : 'up';
    }
    if (dir!==lastDir){
      lastDir=dir;
      if(dir==='up')    socket.emit('input',{dir:{x:0,y:-1}});
      if(dir==='down')  socket.emit('input',{dir:{x:0,y: 1}});
      if(dir==='left')  socket.emit('input',{dir:{x:-1,y:0}});
      if(dir==='right') socket.emit('input',{dir:{x:1,y:0}});
    }
  }

  // Rematch / Yeni rakip / Top100
  restartBtn.addEventListener('click', ()=>{ waitInfo.style.display='block'; socket.emit('rematch'); });
  newOpponentBtn.addEventListener('click', ()=>{ overlay.style.display='flex'; waitInfo.textContent='Yeni rakip aranıyor...'; waitInfo.style.display='block'; socket.emit('find_new'); });

  showHSBtn.addEventListener('click', async()=>{
    try{
      const res=await fetch('/highscores');
      const data=await res.json();
      hsList.innerHTML=data.map((r,i)=>(
        `<li><span class="rank">${i+1}.</span><span class="name">${escapeHtml(r.nick)}</span><span class="score">${r.score}</span></li>`
      )).join('');
      hsModal.style.display='flex';
    }catch(e){}
  });
  hsClose.addEventListener('click', ()=>hsModal.style.display='none');
  hsModal.addEventListener('click', e=>{ if(e.target===hsModal) hsModal.style.display='none'; });

  function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  // Geri sayım
  function startCountdown(cb){
    let count=3;
    countdown.style.display='flex';
    countdown.textContent=count;
    const int=setInterval(()=>{
      count--;
      if(count>0) countdown.textContent=count;
      else if(count===0) countdown.textContent='Başla!';
      else{
        clearInterval(int);
        countdown.style.display='none';
        cb();
      }
    },1000);
  }
})();
</script>
</body>
</html>
