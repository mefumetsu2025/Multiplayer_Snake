<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Multiplayer Snake</title>
<style>
  :root{
    --page:#1a1d1f; --arena:#2a2f34; --panel:#0f1316; --text:#f5f7fa; --muted:#ffffff29; --accent:#e9ebef;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--page);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body.playing{overflow:hidden}

  /* LOGIN */
  #loginScreen{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:16px}
  #loginCard{width:min(440px,92vw);background:var(--panel);border:1px solid #ffffff22;border-radius:14px;box-shadow:0 10px 28px #0007;padding:22px;text-align:center}
  #loginCard h2{margin:0 0 12px}
  .fld{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #ffffff22;background:#0e1114;color:#fff;font-size:16px}
  .btn{width:100%;padding:12px 14px;border-radius:10px;border:0;background:var(--accent);color:#111;font-weight:700;cursor:pointer}
  .error{color:#ff6b6b;font-size:14px;min-height:18px;margin-top:6px}

  /* GAME */
  #gameScreen{display:none;min-height:100dvh;padding:12px 16px}
  #hud{width:min(900px,96vw);margin:0 auto 8px;background:#101418;border:1px solid #ffffff1f;border-radius:12px;padding:8px 10px;box-shadow:0 8px 24px #0006;display:flex;justify-content:center;gap:8px;font-weight:700}
  .badge{padding:6px 10px;border-radius:10px;background:var(--muted)}
  #stageWrap{position:relative;width:100%;display:flex;justify-content:center}
  #gameCanvas{background:var(--arena);border-radius:14px;box-shadow:0 12px 36px #000a, inset 0 0 0 1px #0008;touch-action:none;display:block;margin:0 auto}

  /* Overlay (sonuç + geri sayım) */
  #overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:auto}
  #overlay .box{background:#12161add;border:1px solid #ffffff22;padding:22px 18px;border-radius:14px;text-align:center;min-width:min(420px,92vw)}
  .btn-row{display:flex;gap:8px;margin-top:10px;justify-content:center}
  .btn-s{padding:10px 12px;border-radius:10px;border:0;background:#e9ebef;color:#111;font-weight:700;cursor:pointer}

  /* D-Pad */
  #dpadWrap{display:none;justify-content:center;margin:10px auto 6px;width:min(900px,96vw)}
  .dpad{
    display:grid;grid-template-columns:80px 80px 80px;grid-template-rows:80px 80px 80px;gap:10px;
    touch-action:none;
  }
  .dkey{
    background:#0e1114;border:1px solid #ffffff22;border-radius:14px;color:#fff;font-size:22px;
    display:flex;align-items:center;justify-content:center;user-select:none;box-shadow:0 6px 16px #0008;
  }
  .dkey:active{transform:scale(.98)}
  .dkey span{pointer-events:none}
  .dpad .empty{background:transparent;border:0;box-shadow:none}

  /* Top100 Modal */
  #hsModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:20}
  #hsPanel{position:relative;width:min(720px,92vw);max-height:80vh;overflow:auto;background:#0e1114;border:1px solid #ffffff22;border-radius:14px;box-shadow:0 10px 30px #000a;padding:14px 16px}
  #hsClose{position:absolute;top:8px;right:10px;border:0;background:transparent;color:#fff;font-size:22px;cursor:pointer}
  #hsList{list-style:none;padding-left:0;margin:0}
  #hsList li{display:flex;align-items:center;gap:8px;padding:4px 0}
  #hsList .rank{width:28px;text-align:right;opacity:.85}
  #hsList .name{flex:1;text-align:left;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  #hsList .score{width:56px;text-align:left;opacity:.9}
</style>
</head>
<body>

<!-- LOGIN -->
<section id="loginScreen">
  <div id="loginCard">
    <h2>Multiplayer Snake</h2>
    <input id="nickname" class="fld" placeholder="Kullanıcı adı (max 15)" maxlength="15" />
    <div id="loginError" class="error"></div>
    <button id="startBtn" class="btn">Oyuna Başla</button>
    <div style="opacity:.8;margin-top:8px;font-size:14px">Uygunsuz/müstehcen adlar engellenir. (Aynı IP aynı adı tekrar kullanabilir)</div>
  </div>
</section>

<!-- GAME -->
<section id="gameScreen">
  <div id="hud">
    <div class="badge">Beyaz ⬤ <span id="s1">0</span></div>
    <div class="badge">Süre ⏱ <span id="tm">300</span>s</div>
    <div class="badge">Gri ⬤ <span id="s2">0</span></div>
  </div>

  <div id="stageWrap">
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="overlay">
      <div class="box">
        <h2 id="countdown" style="margin-top:0;display:none;font-size:42px">3</h2>
        <h2 id="resultText" style="margin-top:0">Sonuç</h2>
        <div id="resultScore" style="opacity:.85;margin-bottom:8px"></div>
        <div class="btn-row">
          <button id="restartBtn" class="btn-s">Yeniden Oyna</button>
          <button id="newOpponentBtn" class="btn-s">Yeni Rakip Bul</button>
          <button id="showHSBtn" class="btn-s">Top 100'ü Gör</button>
        </div>
        <div id="waitInfo" style="opacity:.8;margin-top:6px;display:none">Rakip bekleniyor...</div>
      </div>
    </div>
  </div>

  <!-- Tek parça büyük D-pad -->
  <div id="dpadWrap">
    <div class="dpad" id="dpad">
      <div class="empty"></div>
      <div class="dkey" data-dir="up"><span>▲</span></div>
      <div class="empty"></div>
      <div class="dkey" data-dir="left"><span>◀</span></div>
      <div class="dkey" data-dir="down"><span>▼</span></div>
      <div class="dkey" data-dir="right"><span>▶</span></div>
      <div class="empty"></div><div class="empty"></div><div class="empty"></div>
    </div>
  </div>
</section>

<!-- Top100 Modal -->
<div id="hsModal">
  <div id="hsPanel">
    <button id="hsClose" title="Kapat">×</button>
    <h3 style="margin:0 0 8px">Top 100</h3>
    <ol id="hsList"></ol>
  </div>
</div>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>
<script>
(()=> {
  /* --------- ELements --------- */
  const loginScreen = document.getElementById('loginScreen');
  const nicknameInput = document.getElementById('nickname');
  const loginError = document.getElementById('loginError');
  const startBtn = document.getElementById('startBtn');

  const gameScreen = document.getElementById('gameScreen');
  const s1 = document.getElementById('s1'), s2 = document.getElementById('s2'), tm = document.getElementById('tm');
  const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
  const overlay = document.getElementById('overlay');
  const resultText = document.getElementById('resultText'); const resultScore = document.getElementById('resultScore');
  const restartBtn = document.getElementById('restartBtn'); const newOpponentBtn = document.getElementById('newOpponentBtn');
  const waitInfo = document.getElementById('waitInfo'); const countdownEl = document.getElementById('countdown');

  const hsModal = document.getElementById('hsModal'); const hsClose = document.getElementById('hsClose'); const hsList = document.getElementById('hsList');
  const showHSBtn = document.getElementById('showHSBtn');

  const dpadWrap = document.getElementById('dpadWrap'); const dpad = document.getElementById('dpad');

  /* --------- Canvas Fit (DPR aware) --------- */
  const BASE_W=800, BASE_H=600;
  function fitCanvas(){
    const hudH = document.getElementById('hud').getBoundingClientRect().height || 0;
    const dpadH = (dpadWrap.style.display!=='none') ? (dpadWrap.getBoundingClientRect().height||0) : 0;
    const availW = Math.min(window.innerWidth * 0.98, 1400);
    const availH = Math.max(240, window.innerHeight - hudH - dpadH - 24);
    const scale = Math.min(availW/BASE_W, availH/BASE_H);
    const cssW = Math.round(BASE_W * scale), cssH = Math.round(BASE_H * scale);
    const dpr = window.devicePixelRatio || 1;

    canvas.width  = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    canvas.style.width  = cssW+'px';
    canvas.style.height = cssH+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', fitCanvas, {passive:true});

  /* --------- Socket: websocket only --------- */
  const socket = io({ transports: ['websocket'], upgrade: false });

  /* --------- Login --------- */
  startBtn.addEventListener('click', ()=>{
    const nick = nicknameInput.value.trim();
    if (!nick){ loginError.textContent='Kullanıcı adı boş olamaz!'; return; }
    if (nick.length>15){ loginError.textContent='Kullanıcı adı en fazla 15 karakter olabilir.'; return; }
    loginError.textContent='';
    socket.emit('set_nick', nick);
  });
  socket.on('nick_error', msg=> loginError.textContent = msg);

  /* --------- Render loop (RAF) --------- */
  let latestState = null;
  function draw(st){
    const grid=20, W=BASE_W, H=BASE_H;
    ctx.clearRect(0,0,W,H);

    // çerçeve
    ctx.save(); ctx.strokeStyle='#ffffff'; ctx.lineWidth=4; ctx.strokeRect(2,2,W-4,H-4); ctx.restore();

    // yemler
    if(st.food){ ctx.fillStyle='red'; ctx.fillRect(st.food.x*grid, st.food.y*grid, grid, grid); }
    if(st.sfood){ ctx.fillStyle='gold'; ctx.fillRect(st.sfood.x*grid, st.sfood.y*grid, grid, grid); }

    // P1 beyaz
    ctx.fillStyle='#fff';
    for(const p of st.p1.body){
      ctx.fillRect(p.x*grid,p.y*grid,grid,grid);
      ctx.strokeStyle='#111'; ctx.lineWidth=1; ctx.strokeRect(p.x*grid+0.5,p.y*grid+0.5,grid-1,grid-1);
    }
    // P2 gri
    ctx.fillStyle='#9aa0a6';
    for(const p of st.p2.body) ctx.fillRect(p.x*grid,p.y*grid,grid,grid);

    if(st.over){
      let title='Berabere!';
      if(st.winner==='p1') title=(st.n1||'Oyuncu 1')+' Kazandı!';
      else if(st.winner==='p2') title=(st.n2||'Oyuncu 2')+' Kazandı!';
      resultText.textContent = title;
      resultScore.textContent = `${st.n1}: ${st.p1.score} • ${st.n2}: ${st.p2.score}`;
      dpadWrap.style.display='none';
      overlay.style.display='flex';
      document.body.classList.remove('playing');
    }
  }
  (function renderLoop(){ if (latestState) draw(latestState); requestAnimationFrame(renderLoop); })();

  /* --------- Socket events --------- */
  socket.on('match_start', data=>{
    document.body.classList.add('playing');
    loginScreen.style.display='none';
    gameScreen.style.display='block';
    overlay.style.display='none';
    waitInfo.style.display='none';
    resultText.textContent='Sonuç';
    resultScore.textContent='';
    latestState=null; s1.textContent='0'; s2.textContent='0'; tm.textContent=data.duration;

    // mobilde D-pad aç
    if (window.matchMedia('(pointer: coarse)').matches) dpadWrap.style.display='flex';
    else dpadWrap.style.display='none';

    fitCanvas();
    startCountdown(()=> socket.emit('countdown_done'));
    setTimeout(()=> socket.emit('countdown_done'), 2000); // güvenlik ağı
  });

  socket.on('state', st=>{
    latestState = st;
    if(!st.over) tm.textContent = st.left;
    s1.textContent = st.p1.score; s2.textContent = st.p2.score;
  });

  socket.on('rematch_wait', rdy=>{
    waitInfo.style.display = (rdy.p1 && rdy.p2) ? 'none' : 'block';
  });

  /* --------- Countdown --------- */
  function startCountdown(onDone){
    overlay.style.display='flex';
    countdownEl.style.display='block';
    resultText.style.display='none';
    resultScore.style.display='none';
    let n=3; countdownEl.textContent=n;
    const t = setInterval(()=>{
      n--; if(n<=0){ clearInterval(t);
        overlay.style.display='none';
        countdownEl.style.display='none';
        resultText.style.display='block';
        resultScore.style.display='block';
        if (onDone) onDone();
      } else countdownEl.textContent=n;
    }, 700);
  }

  /* --------- Controls --------- */
  function sendDir(dir){ socket.emit('input',{dir}); }

  // Klavye (ok + WASD)
  document.addEventListener('keydown', (e)=>{
    let d=null;
    if (e.key==='ArrowUp'||e.key==='w') d={x:0,y:-1};
    else if (e.key==='ArrowDown'||e.key==='s') d={x:0,y:1};
    else if (e.key==='ArrowLeft'||e.key==='a') d={x:-1,y:0};
    else if (e.key==='ArrowRight'||e.key==='d') d={x:1,y:0};
    if (d){ e.preventDefault(); sendDir(d); }
  });

  // D-pad
  function mapDir(name){
    return name==='up'?{x:0,y:-1}:name==='down'?{x:0,y:1}:name==='left'?{x:-1,y:0}:{x:1,y:0};
  }
  function bindPad(el){
    const dir = el.dataset.dir;
    const down = (ev)=>{ ev.preventDefault(); sendDir(mapDir(dir)); };
    el.addEventListener('touchstart', down, {passive:false});
    el.addEventListener('mousedown', down);
  }
  dpad.querySelectorAll('.dkey').forEach(bindPad);

  // Çift dokunma zoom engeli
  let lastTouch=0;
  window.addEventListener('touchend', (e)=>{ const now=Date.now(); if (now-lastTouch<300) e.preventDefault(); lastTouch=now; }, {passive:false});

  // Rematch / Yeni rakip / Top100
  restartBtn.addEventListener('click', ()=>{ waitInfo.style.display='block'; socket.emit('rematch'); });
  newOpponentBtn.addEventListener('click', ()=>{ overlay.style.display='flex'; waitInfo.textContent='Yeni rakip aranıyor...'; waitInfo.style.display='block'; socket.emit('find_new'); });
  showHSBtn.addEventListener('click', async ()=>{ await refreshHS(); hsModal.style.display='flex'; });
  hsClose.addEventListener('click', ()=> hsModal.style.display='none');
  hsModal.addEventListener('click', (e)=>{ if(e.target===hsModal) hsModal.style.display='none'; });

  async function refreshHS(){
    try{
      const res = await fetch('/highscores');
      const data = await res.json();
      hsList.innerHTML = data.map((r,i)=>(
        `<li><span class="rank">${i+1}.</span><span class="name">${esc(r.nick)}</span><span class="score">${r.score}</span></li>`
      )).join('');
    }catch(e){}
  }
  function esc(s){return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

})();
</script>
</body>
</html>
